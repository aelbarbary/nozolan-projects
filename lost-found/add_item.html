<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Add new item</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="card">
      <h1>Add new item</h1>

      <h2>Title *</h2>
      <input id="title" placeholder="e.g., Black Wallet" />

      <h2>Camera / Photo *</h2>
      <input type="file" accept="image/*" capture="environment" id="camera" />
      <img id="preview" style="display:none; width:100%; max-height:240px; object-fit:cover; border-radius:12px; margin-top:10px;" />

      <button id="save" disabled>Save</button>
      <p id="msg" style="margin-top:10px;"></p>
    </div>

    <script>
      const titleEl = document.getElementById("title");
      const camera = document.getElementById("camera");
      const preview = document.getElementById("preview");
      const save = document.getElementById("save");
      const msg = document.getElementById("msg");

      function setMsg(text, ok = false) {
        msg.textContent = text;
        msg.style.color = ok ? "limegreen" : "salmon";
      }

      function clearMsg() {
        msg.textContent = "";
      }

      function hasImage() {
        return !!(preview.src && preview.src.startsWith("data:image/"));
      }

      function toggleSave() {
        save.disabled = !(titleEl.value.trim() && hasImage());
      }

      camera.addEventListener("change", () => {
        const f = camera.files[0];
        if (!f) {
          preview.src = "";
          preview.style.display = "none";
          toggleSave();
          return;
        }

        const r = new FileReader();
        r.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = "block";
          clearMsg();
          toggleSave();
        };
        r.readAsDataURL(f);
      });

      titleEl.addEventListener("input", () => {
        clearMsg();
        toggleSave();
      });

      window.addEventListener("load", () => {
        titleEl.value = "";
        preview.src = "";
        preview.style.display = "none";
        camera.value = "";
        clearMsg();
        toggleSave();
      });

      save.addEventListener("click", async () => {
        if (save.disabled) return;

        save.disabled = true;
        setMsg("Saving...", true);

        const today = new Date().toISOString().slice(0, 10);

        const payload = {
          title: titleEl.value.trim(),

          // automatic fields (kid-proof)
          status: "Found",
          date: today,

          // required by your current Flask API (so it won't fail)
          location: "Unknown",
          contact: "N/A",

          // image - your backend can store it or ignore it for now
          image_data: preview.src
        };

        try {
          const res = await fetch("https://aelbarbary.pythonanywhere.com/api/items/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            setMsg(data.error ? `Error: ${data.error}` : "Error saving item");
            save.disabled = false;
            return;
          }

          setMsg("âœ… Saved!", true);

          // reset
          titleEl.value = "";
          preview.src = "";
          preview.style.display = "none";
          camera.value = "";
          toggleSave();
        } catch (err) {
          setMsg("Network error. Is Flask running?");
          save.disabled = false;
        }
      });
    </script>
  </body>
</html>
